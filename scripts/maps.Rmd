---
title: "maps"
author: "steppe"
date: "3/22/2022"
output: pdf_document
---

```{r}
#set_here(path = "/hdd/revisionary_taxonomy")
library(here)
library(tidyverse)
library(sf)
library(tigris)
```

```{r import data}
astragalus <- st_read(paste0(here(), '/data/processed/', 'astragalus.shp'), quiet = T)
eriogonum <- st_read(paste0(here(), '/data/processed/', 'eriogonum.shp'), quiet = T)
townsendia <- st_read(paste0(here(), '/data/processed/', 'townsendia.shp'), quiet = T)
```



```{r download political boundaries}
counties_filt <- tigris::counties(state = c('AZ', 'CO', 'UT', 'NM'))
bb <- bind_rows(astragalus, eriogonum, townsendia) %>% 
  st_buffer(50000) %>% 
  st_transform(4269) %>% 
  st_convex_hull()
bb1 <- bind_rows(astragalus, eriogonum, townsendia) %>% 
  st_buffer(9500) %>% 
  st_transform(4269) %>% 
  st_bbox()
counties_filt <- st_crop(counties_filt, bb)

pts <- bind_rows(astragalus, eriogonum, townsendia) %>% 
  st_transform(4269) 

counties_filt1 <- st_cast(counties_filt, 'MULTILINESTRING')

ggplot(counties_filt1) +
  geom_sf() +
  geom_sf(data = pts, aes(color = scntfcN)) +
  coord_sf(xlim = c(bb1[1], bb1[3]), ylim = c(bb1[2], bb1[4])) +  
  theme_bw() 
  
rm(bb)
```

We will download  basemap for making a large overview map
```{r download a basemap}
bb2 <- bb1
names(bb2) <- c('left', 'bottom', 'right', 'top')
basemap <- ggmap::get_stamenmap(bb2,  maptype = "terrain")

ggmap::ggmap(basemap) +
  geom_sf(data = counties_filt1, inherit.aes = FALSE,) +
  geom_sf(data = pts, aes(color = scntfcN), inherit.aes = FALSE,) +
  coord_sf(xlim = c(bb1[1], bb1[3]), ylim = c(bb1[2], bb1[4])) +  
  theme_bw() 

```
## Download and process Road Data

```{r Download roads data for relevant counties and subset}

counties <- st_intersects(counties_filt, pts)
counties <- counties %>% # find counties which intersect
  map(~ if_else(length(.) > 0, T, F))  %>% 
  unlist()
counties <- counties_filt[counties == TRUE, ]

counties <- bind_rows(counties,
                  counties_filt[counties_filt$NAME %in% c('Montrose','Ouray'),])

lst_result <- apply(counties, 1, john_tigger)
county_roads <- bind_rows(lst_result) %>% st_as_sf()
county_roads <- st_crop(county_roads, bb1) # reduce extent.

ggplot(county_roads) +
  geom_sf()

table(county_roads$RTTYP)
```

The [US Census Bureau Route Type Codes](https://www.census.gov/library/reference/code-lists/route-type-codes.html), are displayed below for a lookup table.

   Route Type Code  	      Route Type Code Description
--------------------     ---------------------------------
        C 	                      County
        I 	                      Interstate
        M 	                      Common Name
        O 	                      Other
        S 	                      State recognized
        U  	                      U.S.
------------------      ---------------------------------

We will subset this data frame to have a course map for our overmap reference maps

```{r Subset to Coarse Roads}
roads_coarse <- filter(county_roads, RTTYP %in% c('I','U','S'))

ggplot(roads_coarse) +
  geom_sf()

ggmap::ggmap(basemap) +
  geom_sf(data = counties_filt1, lty = 3, inherit.aes = FALSE) +
  geom_sf(data = pts, aes(color = scntfcN), inherit.aes = FALSE) +
  geom_sf(data = roads_coarse, inherit.aes = F, colour = 'grey20') +
  coord_sf(xlim = c(bb1[1], bb1[3]), ylim = c(bb1[2], bb1[4])) +  
  theme_bw() 
```
```{r subset finer roads to relevant areas}


```


## create more basemaps

Create a couple types of base maps for recycling throughout the process.
```{r create some basemaps}
base <- ggplot() +
  geom_sf(data = montrose_buffer, fill = 'bisque2', alpha = 0.2)  +
  geom_sf(data = montrose) +
  theme_bw()
```



